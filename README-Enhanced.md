# Enhanced APIM - Extract APIs and Artifacts

## Overview

This GitHub Action workflow automates the extraction of API definitions and artifacts from an Azure API Management (APIM) instance for a specified environment. It supports both regular and backup extractions, ensuring the extracted artifacts are safely stored, versioned, and tagged.

The workflow creates a pull request with the extracted artifacts and adds versioned tags for easy tracking of successful extractions.

---

## Features

- **Environment-Aware Extraction**: Extract APIs for any environment, such as `dev.1`, `qa.3`, or `uat.2`.
- **Backup Support**: Automatically mark an extraction as a backup and generate backup branches.
- **Retry Mechanism**: Built-in retry logic ensures that the extraction and downloads are resilient to transient failures.
- **Versioning and Tagging**: Creates and maintains versioned tags for successful extractions while cleaning up older tags.
- **Automated PR Creation**: Generates a pull request with the extracted artifacts for further review and deployment.

---

## Inputs

The workflow supports the following input parameters:

| Input Name               | Description                                     | Required | Type            | Default           |
|--------------------------|-------------------------------------------------|----------|-----------------|-------------------|
| `environment`            | Environment to extract from (e.g., `dev.1`).    | ✅       | `string`        | `dev.1`           |
| `IS_BACKUP`              | Whether the extraction is a backup or not.      | ❌       | `boolean`       | `false`           |
| `API_SPECIFICATION_FORMAT` | Format of the API specification.              | ✅       | `string`        | `OpenAPIV3Yaml`   |

---

## Outputs

The workflow does not explicitly generate outputs, but it:

1. Creates a pull request containing extracted artifacts.
2. Tags the repository with versioned tags to reflect successful extractions.
3. Uploads artifacts for further downstream use.

---

## Permissions

The following permissions are required for this workflow:

- `id-token: write`: Required for authentication.
- `contents: write`: To manage and commit extracted artifacts.
- `pull-requests: write`: To create pull requests.

---

## Prerequisites

- **Secrets**: Ensure the following Azure credentials are available as GitHub secrets:
  - `AZURE_CLIENT_ID`
  - `AZURE_CLIENT_SECRET`
  - `AZURE_TENANT_ID`
  - `AZURE_SUBSCRIPTION_ID`

- **Variables**: Define APIM-specific environment variables:
  - `AZURE_RESOURCE_GROUP_NAME`
  - `API_MANAGEMENT_SERVICE_NAME`

- **Self-Hosted Runner**: This workflow requires a self-hosted runner with access to Azure API Management.

---

## Workflow Steps

Here is a breakdown of the workflow's key steps:

1. **PowerShell Setup**:
   - Installs PowerShell if it’s not already available.

2. **Azure PowerShell Module**:
   - Installs the Azure PowerShell module for interacting with Azure resources.

3. **Determine Branch Name**:
   - Creates a branch name based on the `IS_BACKUP` input and the environment.

4. **Checkout Branch**:
   - Checks out the target branch or creates it if it does not exist.

5. **Clear Output Folder**:
   - Clears any previous artifacts in the APIM folder.

6. **Run the Extractor**:
   - Downloads the extractor tool and extracts APIs with retry logic for resiliency.

7. **Upload Artifacts**:
   - Uploads the extracted API definitions as artifacts for further processing.

8. **Create Pull Request**:
   - Automatically creates a pull request with the extracted artifacts.

9. **Tag Successful Extractions**:
   - Adds a versioned tag for successful extractions while deleting older tags (older than 7 days).

---

## How to Use

### Trigger Workflow

1. **Manually Dispatch**:
   - Go to the GitHub repository.
   - Navigate to the **Actions** tab.
   - Select **Enhanced APIM - Extract APIs and Artifacts** workflow.
   - Click **Run Workflow** and provide inputs:
     - `environment` (e.g., `dev.1` or `qa.3`)
     - `IS_BACKUP` (optional, `true` or `false`)
     - `API_SPECIFICATION_FORMAT` (e.g., `OpenAPIV3Yaml`).

2. **Workflow Call**:
   Include this workflow as a reusable step in another workflow:
   ```yaml
   jobs:
     apim-extract:
       uses: your-repo-name/your-workflow-name/.github/workflows/extract-apim.yaml@main
       with:
         environment: dev.1
         IS_BACKUP: false
         API_SPECIFICATION_FORMAT: OpenAPIV3Yaml
   ```

---

## Example Pull Request Created by the Workflow

- **Title**: `APIM Extraction for environment dev.1 - Successful`
- **Body**:
   ```
   This PR is auto-generated by GitHub Actions workflow for environment dev.1.
   Extraction Type: Regular
   ```
- **Labels**: `extract`, `automated pr`, `backup` (if applicable).

---

## Tagging Logic

- Tags are named as:
  ```
  <environment>-extraction-successful-<YYYYMMDD>
  ```
- Example: `dev.1-extraction-successful-20240427`

- **Old Tags Cleanup**:
   Tags older than 7 days are automatically deleted to keep the repository clean.

---

## Debugging

1. Monitor the workflow logs in the **Actions** tab.
2. Key logging outputs include:
   - Environment variables used.
   - Download and retry attempts for the extractor tool.
   - API extraction progress.

3. To manually verify shard status, check the uploaded artifacts or the pull request created.

---

## Conclusion

This GitHub Action simplifies the extraction of APIs and artifacts from Azure API Management environments. It ensures backup support, automated pull requests, and successful tagging, streamlining the API management lifecycle for development, QA, and production environments.
